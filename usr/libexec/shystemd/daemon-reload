# @file		daemon-reload
# 		scans the system directory and rebuilds the dependencies
#
# @author	Wes Garland, wes@kingsds.network
# @date		Feb 2022
#

. "${SHYSTEMD_LIB_DIR}"/parse-unit

mkdir -p "${SYSTEMD_CONF_ROOT}"/shystemd-db/system
rm -f "${SYSTEMD_CONF_ROOT}"/shystemd-db/system/*

(cd "${SYSTEMD_CONF_ROOT}" && ls system/*.service)\
| while read file
  do
    parseUnit "${SYSTEMD_CONF_ROOT}/$file" > "${SYSTEMD_CONF_ROOT}/shystemd-db/$file.mk"
  done

(cd "${SYSTEMD_CONF_ROOT}/system" && ls *.service)\
| sed 's/\.service$//' \
| while read unit
  do
    $make unit="$unit" -f "${SHYSTEMD_LIB_DIR}"/service.mk deps
  done